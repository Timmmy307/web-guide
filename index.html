<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ultraviolet</title>
  <meta name="description" content="Ultraviolet static site launcher. Type a URL or a search, we'll proxy via /?service= then /service/." />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:32px}
    main{max-width:860px;margin:0 auto}
    h1{margin:0 0 12px}
    form{margin-top:20px}
    input{width:100%;max-width:720px;padding:12px;border:1px solid #ddd;border-radius:10px}
    .tip{color:#666;font-size:14px;margin-top:12px}
    .warn{background:#fff3cd;color:#664d03;border:1px solid #ffecb5;padding:10px;border-radius:8px;display:none;margin:16px 0}
    .hidden{display:none}
  </style>
</head>
<body>
<main>
  <h1>Ultraviolet</h1>

  <!-- Shown if UV core isn't loaded yet -->
  <div id="warn" class="warn">
    <strong>Action required:</strong> Make sure <code>uv.bundle.js</code> and <code>uv.handler.js</code> are present at the site root.
  </div>

  <form id="go" action="/" method="GET" autocomplete="off">
    <input id="q" name="q" placeholder="Type a URL (auto https://) or a search (DuckDuckGo)" autofocus />
  </form>

  <p class="tip">
    Examples: <code>duckduckgo.com</code> → https added • <code>cats and dogs</code> → DuckDuckGo search
  </p>
</main>

<!-- Ultraviolet core (must be same-origin files; SW needs these) -->
<script src="/uv.bundle.js" defer></script>
<script src="/uv.config.js" defer></script>
<script src="/register-sw.js" defer></script>

<script>
  // Normalize input: add https:// to bare domains; otherwise DuckDuckGo (?q=)
  function normalizeTarget(s){
    s = (s || "").trim();
    if (!s) return "";
    if (/^https?:\/\//i.test(s)) return s;
    if (/\./.test(s) && !/\s/.test(s)) return "https://" + s;
    return "https://duckduckgo.com/?q=" + encodeURIComponent(s);
  }

  // 1) Form submit -> encode via UV, but navigate via query: /?service=<encoded>
  document.getElementById('go').addEventListener('submit', (e) => {
    e.preventDefault();
    const q = document.getElementById('q').value;
    const target = normalizeTarget(q);
    if (!target) return;

    if (window.Ultraviolet && self.__uv$config && Ultraviolet.codec?.xor?.encode) {
      const encoded = Ultraviolet.codec.xor.encode(target);
      // On GH Pages, loading root ensures SW can register (HTTPS required)
      location.href = "/?service=" + encoded;
    } else {
      document.getElementById('warn').style.display = 'block';
      console.warn("Ultraviolet core not loaded yet. Ensure uv.bundle.js and uv.handler.js exist.");
    }
  });

  // 2) Boot from query-mode: if ?service=... present, wait for SW, then jump to /service/<encoded>
  (function bootFromServiceParam(){
    const sp = new URLSearchParams(location.search);
    const svc = sp.get('service');
    if (!svc) return;

    function cleanupURL() { history.replaceState(null, '', '/'); }
    function go() {
      cleanupURL();
      // UV default prefix is /service/ (matches official config)
      location.replace(self.__uv$config.prefix + svc);
    }

    // If SW already ready, go immediately; else wait a moment for registration
    if (navigator.serviceWorker && navigator.serviceWorker.ready) {
      navigator.serviceWorker.ready.then(go).catch(go);
    } else {
      setTimeout(go, 300);
    }
  })();

  // 3) Optional: support /?q=... deep links (treat like a search box submit)
  (function bootFromQuery(){
    const params = new URLSearchParams(location.search);
    const q = params.get('q');
    if (!q || params.has('service')) return; // handled above
    const target = normalizeTarget(q);
    if (!target) return;
    if (window.Ultraviolet && self.__uv$config && Ultraviolet.codec?.xor?.encode) {
      const encoded = Ultraviolet.codec.xor.encode(target);
      location.replace("/?service=" + encoded);
    }
  })();
</script>

<noscript>
  <p style="color:#b00020;margin-top:16px">
    JavaScript is required for Ultraviolet to run. Enable JS and reload this page.
  </p>
</noscript>
</body>
</html>
